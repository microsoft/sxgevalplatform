trigger:
  branches:
    include:
      - users/serajag/deploymentPipelineSetup

parameters:
- name: deployInfrastructure
  displayName: 'Infrastructure Deployment'
  type: string
  values:
  - 'Auto'
  - 'Force'
  - 'Skip'
  default: 'Auto'

variables:
  azureSubscription: 'SXGCore_ConfigService_Dev'
  resourceGroup: 'rg-sxg-agent-evaluation-platform'
  rgNamePrefix: 'sxg-core-eval-rg-'
  commonRegion: 'westus2'
  regions: 'westus2 eastus2'
  azureClientId: 'your-client-id'
  azureTenantId: 'your-tenant-id'
  azureAdClientId: 'your-ad-client-id'
  componentId: '409ab2c3-dafd-4ee4-b158-b405c578bbcd'
  serviceName: 'Eval'
  resourcePrefix: 'sxg-eval'
  CDP_DEFINITION_BUILD_COUNT: $[counter('', 0)] # needed for onebranch.pipeline.version task https://aka.ms/obpipelines/versioning
  WindowsContainerImage: 'onebranch.azurecr.io/windows/ltsc2022/vse2022:latest'
  REPO_ROOT: '$(Build.SourcesDirectory)'
  downloadArtifactName: 'EvalArtifact'

stages:
# ---------------------------
# Stage 1: Infrastructure Setup
# ---------------------------
- stage: Infrastructure
  displayName: 'Provision Azure Resources'
  jobs:
    - job: DeployInfra
      displayName: 'Deploy Infrastructure'
      pool:
        vmImage: 'windows-latest'
      steps:
        - checkout: self

        - task: AzureCLI@2
          condition: succeeded()
          inputs:
            azureSubscription: $(azureSubscription)
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              echo "Deploying Azure resources..."

              resourceGroup="$(rgNamePrefix)common-dev"
              echo "Checking if resource group $resourceGroup exists..."
              if az group exists --name $resourceGroup; then
                echo "Resource group $resourceGroup already exists."
              else
                echo "Creating resource group $resourceGroup..."
                az group create --name $resourceGroup --location $(commonRegion)
              fi

              az deployment group create \
                --resource-group $resourceGroup \
                --template-file infrastructure/main.bicep \
                --parameters environment=dev location=$(commonRegion) \
                azureClientId=$(azureClientId) azureTenantId=$(azureTenantId) azureAdClientId=$(azureAdClientId) \
                componentId=$(componentId) serviceName=$(serviceName) resourcePrefix=$(resourcePrefix)

# ---------------------------
# Stage 2: Build & Deploy to Dev
# ---------------------------
# - stage: Dev
#   displayName: 'Build and Deploy to Dev'
#   dependsOn: Infrastructure
#   jobs:
#     - job: BuildAndDeployDev
#       pool:
#         vmImage: 'windows'
#       steps:
#         - checkout: self

#         - task: UseDotNet@2
#           inputs:
#             packageType: 'sdk'
#             version: '7.x'

#         - script: |
#             dotnet build --configuration Release
#             dotnet publish -c Release -o $(Build.ArtifactStagingDirectory)
#           displayName: 'Build and Publish'

#         - task: AzureWebApp@1
#           inputs:
#             azureSubscription: $(azureSubscription)
#             appName: $(appName)-dev
#             package: '$(Build.ArtifactStagingDirectory)'

# ---------------------------
# Stage 3: Deploy to PPE
# ---------------------------
# - stage: PPE
#   displayName: 'Deploy to PPE'
#   dependsOn: Dev
#   jobs:
#     - deployment: DeployQA
#       environment: 'PPE'
#       pool:
#         vmImage: 'windows'
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               - task: AzureWebApp@1
#                 inputs:
#                   azureSubscription: $(azureSubscription)
#                   appName: $(appName)-qa
#                   package: '$(Pipeline.Workspace)/BuildAndDeployDev'

# # ---------------------------
# # Stage 4: Deploy to Prod
# # ---------------------------
# - stage: Prod
#   displayName: 'Deploy to Production'
#   dependsOn: PPE
#   jobs:
#     - deployment: DeployProd
#       environment: 'Prod'
#       pool:
#         vmImage: 'windows'
#       strategy:
#         runOnce:
#           deploy:
#             steps            steps:
#               - task: AzureWebApp@1
#                 inputs:
#                   azureSubscription: $(azureSubscription)
#                   appName: $(appName)