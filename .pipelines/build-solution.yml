#################################################################################
#                         OneBranch Pipelines - Solution Build                  #
# This pipeline builds Dataverse solutions and creates importable files        #
# with code signing support.                                                    #
# Documentation:  https://aka.ms/obpipelines                                    #
# Yaml Schema:    https://aka.ms/obpipelines/yaml/schema                        #
# Retail Tasks:   https://aka.ms/obpipelines/tasks                              #
# Support:        https://aka.ms/onebranchsup                                   #
#################################################################################

trigger: none

parameters:
  - name: solutionName
    displayName: 'Solution to Build'
    type: string
    default: 'dev'
    values:
      - 'dev'
      # Add more solutions here as they are created

  - name: 'debug'
    displayName: 'Enable debug output'
    type: boolean
    default: false

variables:
  CDP_DEFINITION_BUILD_COUNT: $[counter('', 0)]
  system.debug: ${{ parameters.debug }}
  ENABLE_PRS_DELAYSIGN: 1
  ROOT: $(Build.SourcesDirectory)
  REPOROOT: $(Build.SourcesDirectory)
  OUTPUTROOT: $(REPOROOT)\out
  NUGET_XMLDOC_MODE: none
  WindowsContainerImage: 'onebranch.azurecr.io/windows/ltsc2022/vse2022:latest'

resources:
  repositories: 
    - repository: templates
      type: git
      name: OneBranch.Pipelines/GovernedTemplates
      ref: refs/heads/main

extends:
  template: v2/OneBranch.Official.CrossPlat.yml@templates
  parameters:
    cloudvault:
      enabled: false
    globalSdl:
      tsa:
        enabled: false
      binskim:
        break: false
      policheck:
        break: true
    featureFlags:
      WindowsHostVersion: 1ESWindows2022

    stages:
    - stage: build
      jobs:
      - job: main
        pool:
          type: windows
        
        variables:
          ob_outputDirectory: '$(REPOROOT)\out'
          ob_sdl_binskim_break: false
          ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/master') }}:
            ob_symbolsPublishing_enabled: true

        steps:
          - task: onebranch.pipeline.version@1
            displayName: 'Setup BuildNumber'
            inputs:
              system: 'RevisionCounter'
              major: '1'
              minor: '0'
              exclude_commit: true

          - task: UseDotNet@2
            displayName: 'Use .NET Core sdk 8.0.x'
            inputs:
              version: 8.0.x
              includePreviewVersions: true

          - task: CmdLine@2
            displayName: 'Restore Plugins Package'
            inputs:
              script: 'dotnet restore "$(Build.SourcesDirectory)\src\Plugins\SxG.EvalPlatform.Plugins\SxG.EvalPlatform.Plugins.csproj"'
              workingDirectory: '$(Build.SourcesDirectory)\src\Plugins\SxG.EvalPlatform.Plugins'

          - task: MSBuild@1
            displayName: "Build and Publish Plugins"
            inputs:
                solution: '$(Build.SourcesDirectory)\src\Plugins\SxG.EvalPlatform.Plugins\SxG.EvalPlatform.Plugins.csproj'
                configuration: "Release"
                msbuildArguments: '/t:rebuild /p:TargetFramework=net462 /p:OutDir=$(Build.SourcesDirectory)\out\Plugins\ /p:OutputPath=$(Build.SourcesDirectory)\out\Plugins\'
                clean: true

          - task: onebranch.pipeline.signing@1
            displayName: 'Sign Plugin DLLs'
            inputs:
              command: 'sign'
              signing_environment: 'azure-ado'
              files_to_sign: '**/*.dll'
              search_root: '$(Build.SourcesDirectory)\out\Plugins'

          - task: PowerShell@2
            displayName: 'Copy Signed Plugins to Solution Folder'
            inputs:
              targetType: inline
              script: |
                $pluginOutput = "$(Build.SourcesDirectory)\out\Plugins"
                $solutionPluginPath = "$(Build.SourcesDirectory)\src\solutions\${{ parameters.solutionName }}\PluginAssemblies"
                
                if (Test-Path $solutionPluginPath) {
                    Write-Host "Copying signed plugin assemblies from: $pluginOutput"
                    Write-Host "To: $solutionPluginPath"
                    
                    $pluginDlls = Get-ChildItem -Path $pluginOutput -Filter "*.dll" -Recurse
                    foreach ($dll in $pluginDlls) {
                        Write-Host "Copying: $($dll.Name)"
                        Copy-Item -Path $dll.FullName -Destination $solutionPluginPath -Force
                    }
                } else {
                    Write-Host "##vso[task.logissue type=warning]PluginAssemblies folder not found at: $solutionPluginPath"
                }

          - task: PowerShell@2
            displayName: 'Copy Solution Folder to Output'
            inputs:
              targetType: inline
              script: |
                $sourcePath = "$(Build.SourcesDirectory)\src\solutions\${{ parameters.solutionName }}"
                $destPath = "$(Build.SourcesDirectory)\out\Solutions\${{ parameters.solutionName }}"
                
                Write-Host "Copying solution folder from: $sourcePath"
                Write-Host "To: $destPath"
                
                if (Test-Path $sourcePath) {
                    Copy-Item -Path $sourcePath -Destination $destPath -Recurse -Force
                    Write-Host "Solution folder copied successfully"
                } else {
                    Write-Host "##vso[task.logissue type=error]Solution folder not found at: $sourcePath"
                    exit 1
                }
