{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "paths": [
    "servicePackageLink"
  ],
  "parameters": {
    "appService_name": {
      "type": "string"
    },
    "appService_location": {
      "type": "string"
    },
    "appServicePlan_name": {
      "type": "string"
    },
    "appService_slot": {
      "type": "string"
    },
    "Sites_buildVersion": {
      "type": "string"
    },
    "servicePackageLink": {
      "type": "string"
    },
    "alwaysOn": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether the web app should remain loaded after 20 minutes of inactivity."
      }
    },
    "environmentName": {
      "type": "string",
      "metadata": {
        "description": "Environment name (e.g., Production, PPE, Development)"
      }
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "metadata": {
        "description": "Application Insights Instrumentation Key"
      }
    },
    "appInsightsConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Application Insights Connection String"
      }
    },
    "cacheRedisEndpoint": {
      "type": "string",
      "metadata": {
        "description": "Redis Cache endpoint"
      }
    },
    "cacheRedisInstanceName": {
      "type": "string",
      "metadata": {
        "description": "Redis Cache instance name"
      }
    },
    "serviceBusConnection": {
      "type": "string",
      "metadata": {
        "description": "Service Bus connection endpoint"
      }
    },
    "StorageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Service Bus connection endpoint"
      }
    },
    "userAssignedIdentity_resourceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the User Assigned Managed Identity"
      }
    }
  },
  "resources": [
    {
      "comments": "The staging slot for the web app",
      "apiVersion": "2022-09-01",
      "type": "Microsoft.Web/sites/slots",
      "kind": "app",
      "name": "[concat(parameters('appService_name'), '/', parameters('appService_slot'))]",
      "location": "[parameters('appService_location')]",
      "properties": {
        "enabled": true,
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlan_name'))]",
        "buildVersion": "[parameters('Sites_buildVersion')]"
      },
      "resources": [
        {
          "comments": "-----Staging Slot: App Settings-----",
          "apiVersion": "2022-09-01",
          "name": "appsettings",
          "type": "config",
          "location": "[parameters('appService_location')]",
          "dependsOn": [
            "[resourceId('Microsoft.Web/Sites/slots', parameters('appService_name'), parameters('appService_slot'))]"
          ],
          "properties": {
            "Sites_buildVersion": "[parameters('Sites_buildVersion')]",
            "AllowedHosts": "*",
            "ApiSettings__Environment": "[parameters('environmentName')]",
            "ApiSettings__Version": "1.0.0",
            "APPINSIGHTS_INSTRUMENTATIONKEY": "[parameters('appInsightsInstrumentationKey')]",
            "APPINSIGHTS_PROFILERFEATURE_VERSION": "1.0.0",
            "APPINSIGHTS_SNAPSHOTFEATURE_VERSION": "1.0.0",
            "APPLICATIONINSIGHTS_CONNECTION_STRING": "[parameters('appInsightsConnectionString')]",
            "APPLICATIONINSIGHTS_ENABLESQLQUERYCOLLECTION": "disabled",
            "ApplicationInsightsAgent_EXTENSION_VERSION": "~3",
            "ASPNETCORE_ENVIRONMENT": "Production",
            "Authentication__ClockSkewMinutes": "5",
            "Authentication__MISE__AllowStandardBearerTokens": "True",
            "Authentication__MISE__EnableEventLogging": "True",
            "Authentication__MISE__RequireProtectedTokens": "False",
            "Authentication__RequireHttpsMetadata": "True",
            "Authentication__SaveToken": "False",
            "Authentication__ValidateAudience": "True",
            "Authentication__ValidateIssuer": "True",
            "Authentication__ValidateIssuerSigningKey": "True",
            "Authentication__ValidateLifetime": "True",
            "AzureAd__Audience": "api://dafa5810-9bba-4c5b-b443-abe1a40aa240",
            "AzureAd__ClientId": "dafa5810-9bba-4c5b-b443-abe1a40aa240",
            "AzureAd__Instance": "https://login.microsoftonline.com/",
            "AzureAd__TenantId": "72f988bf-86f1-41af-91ab-2d7cd011db47",
            "AzureAd__ValidIssuers__0": "https://login.microsoftonline.com/common/v2.0",
            "AzureAd__ValidIssuers__1": "https://sts.windows.net/common/",
            "AzureStorage__AccountName": "[parameters('StorageAccountName')]",
            "AzureStorage__DatasetEnrichmentRequestsQueueName": "dataset-enrichment-requests",
            "AzureStorage__DataSetFolderName": "datasets",
            "AzureStorage__DatasetsFolderName": "datasets",
            "AzureStorage__DataSetsTable": "DataSetsTable",
            "AzureStorage__DefaultMetricsConfiguration": "default-metric-configuration.json",
            "AzureStorage__EvalProcessingRequestsQueueName": "eval-processing-requests",
            "AzureStorage__EvalResultsFolderName": "evaluation-results",
            "AzureStorage__EvalRunsTable": "EvalRunsTable",
            "AzureStorage__MetricsConfigurationsFolderName": "metrics-configurations",
            "AzureStorage__MetricsConfigurationsTable": "MetricsConfigurationsTable",
            "AzureStorage__PlatformConfigurationsContainer": "platform-configurations",
            "Cache__DefaultExpirationMinutes": "60",
            "Cache__Memory__CompactionPercentage": "0.25",
            "Cache__Memory__ExpirationScanFrequencySeconds": "60",
            "Cache__Memory__SizeLimitMB": "100",
            "Cache__Provider": "None",
            "Cache__Redis__CommandTimeoutSeconds": "3",
            "Cache__Redis__ConnectTimeoutSeconds": "5",
            "Cache__Redis__Endpoint": "[parameters('cacheRedisEndpoint')]",
            "Cache__Redis__InstanceName": "[parameters('cacheRedisInstanceName')]",
            "Cache__Redis__Retry__BaseDelayMs": "500",
            "Cache__Redis__Retry__Enabled": "True",
            "Cache__Redis__Retry__MaxDelayMs": "2000",
            "Cache__Redis__Retry__MaxRetryAttempts": "2",
            "Cache__Redis__UseManagedIdentity": "True",
            "Cache__Redis__UseSsl": "True",
            "DataVerseAPI__DatasetEnrichmentRequestAPIEndPoint": "https://sxg-eval-prod.crm.dynamics.com/api/data/v9.2/cr890_PostEvalRun",
            "DataVerseAPI__Scope": "https://sxg-eval-prod.crm.dynamics.com/.default",
            "DiagnosticServices_EXTENSION_VERSION": "~3",
            "DISABLE_APPINSIGHTS_SDK": "disabled",
            "FeatureFlags__EnableAuthentication": "True",
            "FeatureFlags__EnablePublishingEvalResultsToDataPlatform": "True",
            "IGNORE_APPINSIGHTS_SDK": "disabled",
            "InstrumentationEngine_EXTENSION_VERSION": "disabled",
            "Logging__ApplicationInsights__LogLevel__Default": "Information",
            "Logging__ApplicationInsights__LogLevel__Microsoft": "Warning",
            "Logging__LogLevel__Default": "Information",
            "Logging__LogLevel__Microsoft.ApplicationInsights": "Warning",
            "Logging__LogLevel__Microsoft.AspNetCore": "Warning",
            "OpenTelemetry__CloudRoleName": "SXG-EvalPlatform-API",
            "OpenTelemetry__EnableApplicationInsights": "True",
            "OpenTelemetry__EnableConsoleExporter": "False",
            "OpenTelemetry__ExportTimeoutMilliseconds": "30000",
            "OpenTelemetry__MaxExportBatchSize": "100",
            "OpenTelemetry__SamplingRatio": "0.1",
            "OpenTelemetry__ServiceName": "SXG-EvalPlatform-API",
            "OpenTelemetry__ServiceVersion": "1.0.0",
            "RateLimiting__IpPolicy__PermitLimit": "100",
            "RateLimiting__IpPolicy__WindowSeconds": "60",
            "RateLimiting__SessionPolicy__PermitLimit": "30",
            "RateLimiting__SessionPolicy__WindowSeconds": "60",
            "RateLimiting__UserPolicy__PermitLimit": "50",
            "RateLimiting__UserPolicy__WindowSeconds": "60",
            "ServiceBus__EventBusConnection": "[parameters('serviceBusConnection')]",
            "SnapshotDebugger_EXTENSION_VERSION": "disabled",
            "Telemetry__AppInsightsConnectionString": "[parameters('appInsightsConnectionString')]",
            "XDT_MicrosoftApplicationInsights_BaseExtensions": "disabled",
            "XDT_MicrosoftApplicationInsights_Mode": "recommended",
            "XDT_MicrosoftApplicationInsights_PreemptSdk": "disabled"
          }
        }
      ]
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "Eval_DeploymentScript",
      "location": "[parameters('appService_location')]",
      "kind": "AzureCLI",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[parameters('userAssignedIdentity_resourceId')]": {}
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/Sites/slots', parameters('appService_name'), parameters('appService_slot'))]"
      ],
      "properties": {
        "azCliVersion": "2.52.0",
        "timeout": "PT30M",
        "retentionInterval": "P1D",
        "cleanupPreference": "OnSuccess",
        "arguments": "[concat(parameters('appService_name'), ' ', parameters('appService_slot'), ' ', resourceGroup().name, ' \"', parameters('servicePackageLink'), '\" ', subscription().subscriptionId)]",
        "scriptContent": "az account set --subscription \"$5\" && wget -O app.zip \"$4\" && az webapp deployment source config-zip --name $1 --slot $2 --resource-group $3 --src app.zip"
      }
    }
  ]
}